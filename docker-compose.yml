# docker-compose.yml
# Purpose: bring up 3 containers for a Laravel app: php-fpm (app), nginx, and mysql.
# NOTE: modern Docker Compose doesn't require the `version` key — you can remove it.
# (You previously saw the warning about `version` being obsolete.)

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: laravel_app:latest
    container_name: laravel_app
    # Mount project dir into container (two-way sync). Use `:delegated` for better performance on macOS/Windows.
    volumes:
      - ./:/var/www/html:delegated
    # Ensure DB container starts before app container (only controls start order — does not wait for DB readiness).
    depends_on:
      - mysql
    # (Optional) Add restart policy in development:
    # restart: unless-stopped

  nginx:
    image: nginx:stable
    container_name: nginx_laravel
    # Map host port 8000 to container port 80 (so you'll open http://localhost:8000)
    ports:
      - "8000:80" # Access nginx at localhost:8000
    # Mount app code read-only for nginx (safer) and use custom nginx config
    volumes:
    - ./:/var/www/html:ro
    - ./docker/nginx/docker-compose.conf:/etc/nginx/conf.d/default.conf:ro  # NEW 
    depends_on:
      - app
    # Note: depends_on only controls start ordering (not readiness). Consider healthchecks if you need nginx to wait until php-fpm is listening.

  mysql:
    image: mysql:8.0
    container_name: mysql_laravel
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: laravel
      MYSQL_USER: laravel
      MYSQL_PASSWORD: secret
    # Persist DB data on the Docker host
    volumes:
      - db_data:/var/lib/mysql
    # Expose database on host port 3307 -> container 3306 (optional; useful for connecting with GUI tools)
    ports:
      - "3307:3306"

volumes:
  # named volume that stores MySQL data
  db_data:
